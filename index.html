<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civil Rights Interview Archive</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration - replace these values with your actual Firebase project settings
        const firebaseConfig = {
            apiKey: "AIzaSyDGolxlZNoEzk7z46ZMtSk9YsP32MlH45Q",
            authDomain: "llm-hyper-audio.firebaseapp.com",
            projectId: "llm-hyper-audio",
            storageBucket: "llm-hyper-audio.firebasestorage.app",
            messagingSenderId: "530304773274",
            appId: "1:530304773274:web:1764f58974d6c2fd060323",
            measurementId: "G-HFEKE65YC6"
        };

        // To configure Firebase:
        // 1. Go to your Firebase Console (https://console.firebase.google.com/)
        // 2. Select your project
        // 3. Click the gear icon ‚Üí Project settings
        // 4. Scroll down to "Your apps" section
        // 5. Click on your web app or create one
        // 6. Copy the firebaseConfig object from the SDK setup
        // 7. Replace the values above with your actual configuration
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            border-radius: 10px;
        }

        header h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            text-align: center;
            font-size: 1.2em;
            opacity: 0.9;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .search-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-bar input,
        .search-bar select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .search-bar input {
            flex: 1;
            min-width: 200px;
        }

        .search-bar select {
            min-width: 150px;
        }

        .load-data-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .load-data-btn:hover {
            background: #2980b9;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }

        .interviews-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }

        .interview-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .interview-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .interview-header {
            background: #34495e;
            color: white;
            padding: 20px;
        }

        .interview-header h3 {
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .interview-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .interview-content {
            padding: 20px;
        }

        .interview-summary {
            margin-bottom: 15px;
            color: #555;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tag {
            background: #ecf0f1;
            color: #2c3e50;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .tag.topic {
            background: #e8f5e8;
            color: #27ae60;
        }

        .tag.event {
            background: #fff3e0;
            color: #f39c12;
        }

        .chapters-preview {
            font-size: 0.9em;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 0;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 10px;
            position: relative;
        }

        .modal-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            cursor: pointer;
            background: none;
            border: none;
            color: white;
        }

        .modal-body {
            padding: 30px;
        }

        .chapter {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }

        .chapter-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .chapter-title {
            color: #2c3e50;
            font-size: 1.2em;
            font-weight: bold;
            flex: 1;
        }

        .chapter-time {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            white-space: nowrap;
            margin-left: 15px;
        }

        .timestamp-link {
            cursor: pointer;
            text-decoration: underline;
            transition: opacity 0.2s;
        }

        .timestamp-link:hover {
            opacity: 0.8;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .chapter-summary {
            margin-bottom: 15px;
            color: #555;
        }

        .chapter-events {
            margin-top: 10px;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .interviews-grid {
                grid-template-columns: 1fr;
            }

            .search-bar {
                flex-direction: column;
            }

            .search-bar input,
            .search-bar select {
                width: 100%;
            }

            .modal-content {
                width: 95%;
                margin: 1% auto;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Civil Rights Interview Archive</h1>
            <p>Explore oral histories with AI-powered analysis and event tagging</p>
        </header>

        <div class="controls">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search interviews, events, or topics...">
                <select id="topicFilter">
                    <option value="">All Topics</option>
                    <option value="Voting & Legal Rights">Voting & Legal Rights</option>
                    <option value="Organizations & Movement Networks">Organizations & Movement Networks</option>
                    <option value="Violence, Intimidation & State Repression">Violence, Intimidation & State Repression
                    </option>
                    <option value="Integration, Education & Everyday Segregation">Integration, Education & Everyday
                        Segregation</option>
                    <option value="Historical Figures & Turning Points">Historical Figures & Turning Points</option>
                </select>
                <select id="eventFilter">
                    <option value="">All Events</option>
                </select>
                <button class="load-data-btn" onclick="loadFromFirestore()">Load from Firestore</button>
                <button class="load-data-btn" onclick="loadFromFile()" style="background: #95a5a6;">Load JSON
                    File</button>
            </div>
            <div id="firebaseStatus" style="margin-top: 10px; padding: 10px; border-radius: 6px; display: none;">
                <strong>Firebase Status:</strong> <span id="statusText">Not connected</span>
            </div>
        </div>

        <div class="stats" id="statsContainer">
            <div class="stat-card">
                <h3>Total Interviews</h3>
                <div class="number" id="totalInterviews">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Chapters</h3>
                <div class="number" id="totalChapters">-</div>
            </div>
            <div class="stat-card">
                <h3>Events Referenced</h3>
                <div class="number" id="totalEvents">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Duration</h3>
                <div class="number" id="totalDuration">-</div>
            </div>
        </div>

        <div id="errorContainer"></div>
        <div id="loadingContainer"></div>

        <div class="interviews-grid" id="interviewsContainer">
            <div class="no-data">
                <h3>No Interview Data Loaded</h3>
                <p>Click "Load from Firestore" to fetch processed interviews from your Firebase database, or "Load JSON
                    File" to upload a local file.</p>
            </div>
        </div>
    </div>

    <!-- Modal for detailed interview view -->
    <div id="interviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Interview Details</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        let interviewsData = [];
        let filteredInterviews = [];
        let db = null;

        // Firebase config is loaded from firebase-config.js

        // Initialize Firebase
        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                updateFirebaseStatus('Connected to Firebase', 'success');
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateFirebaseStatus(`Firebase Error: ${error.message}`, 'error');
                return false;
            }
        }

        // Update Firebase status display
        function updateFirebaseStatus(message, type) {
            const statusContainer = document.getElementById('firebaseStatus');
            const statusText = document.getElementById('statusText');

            statusContainer.style.display = 'block';
            statusText.textContent = message;

            if (type === 'success') {
                statusContainer.style.background = '#d4edda';
                statusContainer.style.color = '#155724';
                statusContainer.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                statusContainer.style.background = '#f8d7da';
                statusContainer.style.color = '#721c24';
                statusContainer.style.border = '1px solid #f5c6cb';
            } else {
                statusContainer.style.background = '#d1ecf1';
                statusContainer.style.color = '#0c5460';
                statusContainer.style.border = '1px solid #bee5eb';
            }
        }

        // Helper function to load a single interview with its chapters
        async function loadInterviewWithChapters(doc, mainData) {
            try {
                console.log(`\n=== Loading interview: ${doc.id} ===`);
                console.log('Main data keys:', Object.keys(mainData));

                // Load chapters from subcollection
                console.log('Attempting to load subSummaries subcollection...');
                console.log('Document reference path:', doc.ref.path);
                console.log('Full subcollection path:', `${doc.ref.path}/subSummaries`);

                const chaptersSnapshot = await doc.ref.collection('subSummaries').orderBy('chapterNumber').get();

                console.log(`Subcollection query result: ${chaptersSnapshot.size} documents found`);

                if (chaptersSnapshot.empty) {
                    console.warn(`No chapters found in subSummaries for ${doc.id}`);
                    console.log('Trying without orderBy in case of missing chapterNumber field...');

                    // Try again without orderBy in case chapterNumber field is missing
                    const retrySnapshot = await doc.ref.collection('subSummaries').get();
                    console.log(`Retry query result: ${retrySnapshot.size} documents found`);
                }

                const chapters = [];

                chaptersSnapshot.forEach((chapterDoc) => {
                    console.log(`Processing chapter document: ${chapterDoc.id}`);
                    const chapterData = chapterDoc.data();
                    console.log('Available chapter fields:', Object.keys(chapterData));
                    console.log('Chapter data sample:', {
                        chapterNumber: chapterData.chapterNumber,
                        topic: chapterData.topic,
                        keyTopics: chapterData.keyTopics?.length || 0,
                        summary: chapterData.summary?.substring(0, 50) + '...'
                    });

                    chapters.push({
                        chapter_number: chapterData.chapterNumber || 0,
                        title: chapterData.topic || '',
                        start_time: chapterData.startTime || '',
                        end_time: chapterData.endTime || '',
                        summary: chapterData.summary || '',
                        key_topics: chapterData.keyTopics || [],  // Exactly 3 topics
                        main_topic_category: chapterData.mainTopicCategory || '',
                        related_events: chapterData.relatedEvents || [],
                        notable_quotes: chapterData.notableQuotes || []
                    });
                });

                // Sort chapters by chapter number to ensure proper ordering
                chapters.sort((a, b) => (a.chapter_number || 0) - (b.chapter_number || 0));

                console.log(`‚úÖ Successfully processed ${chapters.length} chapters for ${doc.id}`);

                // Return in the format expected by the web interface
                const result = {
                    id: doc.id,
                    interview_name: mainData.documentName || doc.id,
                    metadata: mainData.metadata || {},
                    main_summary: {
                        summary: mainData.mainSummary || '',
                        key_themes: mainData.keyThemes || [],
                        historical_significance: mainData.historicalSignificance || ''
                    },
                    chapters: chapters,
                    processing_info: mainData.processingInfo || {},
                    source_file: mainData.sourceFile || '',
                    firestore_id: doc.id,
                    // Legacy fields from interviewSummaries collection
                    role: mainData.role || '',
                    videoEmbedLink: mainData.videoEmbedLink || '',
                    interviewDate: mainData.interviewDate || '',
                    location: mainData.location || '',
                    interviewer: mainData.interviewer || ''
                };

                console.log(`Final result for ${doc.id}: ${result.chapters.length} chapters`);
                return result;

            } catch (error) {
                console.error(`‚ùå Error loading interview ${doc.id}:`, error);
                console.error('Error details:', error.message, error.stack);

                // Return basic structure even if chapter loading fails
                return {
                    id: doc.id,
                    interview_name: mainData.documentName || doc.id,
                    metadata: mainData.metadata || {},
                    main_summary: {
                        summary: mainData.mainSummary || '',
                        key_themes: mainData.keyThemes || [],
                        historical_significance: mainData.historicalSignificance || ''
                    },
                    chapters: [],
                    processing_info: mainData.processingInfo || {},
                    source_file: mainData.sourceFile || '',
                    firestore_id: doc.id,
                    // Legacy fields from interviewSummaries collection
                    role: mainData.role || '',
                    videoEmbedLink: mainData.videoEmbedLink || '',
                    interviewDate: mainData.interviewDate || '',
                    location: mainData.location || '',
                    interviewer: mainData.interviewer || ''
                };
            }
        }

        // Load data from Firestore
        async function loadFromFirestore() {
            const loadingContainer = document.getElementById('loadingContainer');
            const errorContainer = document.getElementById('errorContainer');

            loadingContainer.innerHTML = '<div class="loading">Connecting to Firestore...</div>';
            errorContainer.innerHTML = '';

            // Initialize Firebase if not already done
            if (!db && !initializeFirebase()) {
                loadingContainer.innerHTML = '';
                errorContainer.innerHTML = '<div class="error">Could not connect to Firebase. Please check your configuration.</div>';
                return;
            }

            try {
                updateFirebaseStatus('Loading interviews from Firestore...', 'info');
                loadingContainer.innerHTML = '<div class="loading">Loading interviews from Firestore...</div>';

                // Fetch all interviews from Firestore (using metadataV2 collection)
                const interviewsSnapshot = await db.collection('metadataV2').get();

                if (interviewsSnapshot.empty) {
                    throw new Error('No interviews found in Firestore database.');
                }

                interviewsData = [];

                // Load main documents and their chapters
                const interviewPromises = [];

                interviewsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log(`Main document ${doc.id}:`, data);
                    const interviewPromise = loadInterviewWithChapters(doc, data);
                    interviewPromises.push(interviewPromise);
                });

                interviewsData = await Promise.all(interviewPromises);
                console.log('Final interviewsData:', interviewsData);

                loadingContainer.innerHTML = '';
                updateFirebaseStatus(`Loaded ${interviewsData.length} interviews from Firestore`, 'success');
                updateStats();
                populateFilters();
                displayInterviews();

            } catch (error) {
                loadingContainer.innerHTML = '';
                console.error('Firestore error:', error);
                errorContainer.innerHTML = `<div class="error">Error loading from Firestore: ${error.message}</div>`;
                updateFirebaseStatus(`Error: ${error.message}`, 'error');

                // Fallback to example data
                loadExampleData();
            }
        }

        // Load data from JSON file (original functionality)
        async function loadFromFile() {
            const loadingContainer = document.getElementById('loadingContainer');
            const errorContainer = document.getElementById('errorContainer');

            loadingContainer.innerHTML = '<div class="loading">Loading interview data from file...</div>';
            errorContainer.innerHTML = '';

            try {
                const response = await fetch('interviews_data.json');
                if (!response.ok) {
                    throw new Error('Could not load interviews_data.json. Make sure the file exists or use "Load from Firestore".');
                }

                const data = await response.json();
                interviewsData = data.interviews || [];

                loadingContainer.innerHTML = '';
                updateStats();
                populateFilters();
                displayInterviews();

            } catch (error) {
                loadingContainer.innerHTML = '';
                errorContainer.innerHTML = `<div class="error">Error loading JSON file: ${error.message}</div>`;

                // Show example data for demonstration
                loadExampleData();
            }
        }

        // Load example data for demonstration
        function loadExampleData() {
            interviewsData = [
                {
                    interview_name: "Aaron Dixon",
                    metadata: {
                        total_duration_formatted: "02:45:30",
                        word_count: 15420,
                        total_segments: 342
                    },
                    main_summary: {
                        summary: "Aaron Dixon shares his experiences as a founding member of the Seattle Black Panther Party chapter and his involvement in civil rights activism in the Pacific Northwest. He describes growing up in Seattle, witnessing police brutality, and the formation of the Black Panthers in response to systemic racism. Dixon reflects on the party's community programs, breakfast programs for children, and their efforts to address social issues through direct action.",
                        key_themes: ["Black Panther Party", "Seattle Civil Rights", "Community Organizing", "Police Brutality", "Youth Activism"],
                        historical_significance: "Dixon's account provides unique insight into the Black Panther Party's expansion beyond California and their impact on Pacific Northwest civil rights movements."
                    },
                    chapters: [
                        {
                            chapter_number: 1,
                            title: "Growing Up in Seattle",
                            summary: "Dixon describes his childhood in Seattle's Central District and early experiences with racism in predominantly white schools.",
                            start_time: "00:00:00",
                            end_time: "00:25:15",
                            main_topic_category: "Integration, Education & Everyday Segregation",
                            related_events: [],
                            keywords: ["childhood", "Seattle", "education", "segregation"]
                        },
                        {
                            chapter_number: 2,
                            title: "Formation of Seattle Black Panthers",
                            summary: "Dixon recounts founding the Seattle chapter of the Black Panther Party and their early organizing efforts in the community.",
                            start_time: "00:25:15",
                            end_time: "00:58:42",
                            main_topic_category: "Organizations & Movement Networks",
                            related_events: ["The Involvment of the Black Panthers"],
                            keywords: ["Black Panthers", "organizing", "Seattle", "community"]
                        }
                    ]
                }
            ];

            updateStats();
            populateFilters();
            displayInterviews();
        }

        // Update statistics
        function updateStats() {
            const totalInterviews = interviewsData.length;
            const totalChapters = interviewsData.reduce((sum, interview) => sum + (interview.chapters?.length || 0), 0);
            const allEvents = new Set();
            let totalDurationSeconds = 0;

            interviewsData.forEach(interview => {
                if (interview.metadata?.total_duration_seconds) {
                    totalDurationSeconds += interview.metadata.total_duration_seconds;
                }

                interview.chapters?.forEach(chapter => {
                    chapter.related_events?.forEach(event => allEvents.add(event));
                });
            });

            document.getElementById('totalInterviews').textContent = totalInterviews;
            document.getElementById('totalChapters').textContent = totalChapters;
            document.getElementById('totalEvents').textContent = allEvents.size;
            document.getElementById('totalDuration').textContent = formatDuration(totalDurationSeconds);
        }

        // Populate filter dropdowns
        function populateFilters() {
            const eventFilter = document.getElementById('eventFilter');
            const allEvents = new Set();

            interviewsData.forEach(interview => {
                interview.chapters?.forEach(chapter => {
                    chapter.related_events?.forEach(event => allEvents.add(event));
                });
            });

            // Clear existing options (except "All Events")
            eventFilter.innerHTML = '<option value="">All Events</option>';

            Array.from(allEvents).sort().forEach(event => {
                const option = document.createElement('option');
                option.value = event;
                option.textContent = event;
                eventFilter.appendChild(option);
            });
        }

        // Display interviews
        function displayInterviews() {
            const container = document.getElementById('interviewsContainer');

            if (filteredInterviews.length === 0 && interviewsData.length > 0) {
                filteredInterviews = [...interviewsData];
            }

            if (filteredInterviews.length === 0) {
                container.innerHTML = '<div class="no-data"><h3>No interviews match your filters</h3></div>';
                return;
            }

            container.innerHTML = filteredInterviews.map(interview => `
                <div class="interview-card" onclick="showInterviewDetails('${interview.interview_name}')">
                    <div class="interview-header">
                        <h3>${interview.interview_name}</h3>
                        <div class="interview-meta">
                            <span>${interview.chapters?.length || 0} chapters</span>
                            <span>${interview.metadata?.total_duration_formatted || 'Unknown duration'}</span>
                        </div>
                    </div>
                    <div class="interview-content">
                        <div class="interview-summary">
                            ${interview.main_summary?.summary || 'No summary available'}
                        </div>
                        ${interview.role ? `<div class="tags"><span class="tag" style="background: #e3f2fd; color: #1976d2;">üë§ ${interview.role}</span></div>` : ''}
                        <div class="tags">
                            ${(interview.main_summary?.key_themes || []).map(theme =>
                `<span class="tag topic">${theme}</span>`
            ).join('')}
                        </div>
                        <div class="tags">
                            ${getUniqueEvents(interview).map(event =>
                `<span class="tag event">${event}</span>`
            ).join('')}
                        </div>
                        <div class="chapters-preview">
                            ${(interview.chapters?.length || 0)} chapters ‚Ä¢ ${interview.metadata?.word_count || 0} words
                            ${interview.videoEmbedLink ? ' ‚Ä¢ üé• Video available' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Get unique events from interview
        function getUniqueEvents(interview) {
            const events = new Set();
            interview.chapters?.forEach(chapter => {
                chapter.related_events?.forEach(event => events.add(event));
            });
            return Array.from(events).slice(0, 3); // Limit to 3 for preview
        }

        // Show interview details in modal
        function showInterviewDetails(interviewName) {
            const interview = interviewsData.find(i => i.interview_name === interviewName);
            if (!interview) return;

            document.getElementById('modalTitle').textContent = interview.interview_name;

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div style="margin-bottom: 30px;">
                    ${interview.role ? `<div style="margin-bottom: 15px;"><strong>Role:</strong> ${interview.role}</div>` : ''}
                    ${interview.videoEmbedLink ? `
                        <div style="margin-bottom: 20px;">
                            <h4>Interview Video <span style="font-size: 0.8em; color: #666;">(üí° Click chapter timestamps below to navigate)</span></h4>
                            <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; overflow: hidden;">
                                <iframe src="${interview.videoEmbedLink}" 
                                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
                                        frameborder="0" allowfullscreen allow="autoplay; encrypted-media">
                                </iframe>
                            </div>
                        </div>
                    ` : ''}
                    
                    <h3>Summary</h3>
                    <p>${interview.main_summary?.summary || 'No summary available'}</p>
                    
                    <h4 style="margin-top: 20px;">Key Themes</h4>
                    <div class="tags">
                        ${(interview.main_summary?.key_themes || []).map(theme =>
                `<span class="tag topic">${theme}</span>`
            ).join('')}
                    </div>
                    
                    <h4 style="margin-top: 20px;">Historical Significance</h4>
                    <p>${interview.main_summary?.historical_significance || 'Not specified'}</p>
                </div>

                <h3>Chapters</h3>
                ${(interview.chapters || []).sort((a, b) => (a.chapter_number || 0) - (b.chapter_number || 0)).map(chapter => `
                    <div class="chapter">
                        <div class="chapter-header">
                            <div class="chapter-title">Chapter ${chapter.chapter_number}: ${chapter.title}</div>
                            <div class="chapter-time">
                                ${interview.videoEmbedLink ? `
                                    <span class="timestamp-link" onclick="navigateToTimestamp('${chapter.start_time}', '${interview.interview_name}')" title="Click to jump to this time in the video (Raw: ${chapter.start_time})">
                                        ${formatTimestamp(chapter.start_time)}
                                    </span>
                                    -
                                    <span class="timestamp-link" onclick="navigateToTimestamp('${chapter.end_time}', '${interview.interview_name}')" title="Click to jump to this time in the video (Raw: ${chapter.end_time})">
                                        ${formatTimestamp(chapter.end_time)}
                                    </span>
                                ` : `
                                    ${formatTimestamp(chapter.start_time)} - ${formatTimestamp(chapter.end_time)}
                                `}
                            </div>
                        </div>
                        <div class="chapter-summary">${chapter.summary}</div>
                        <div class="tags">
                            <span class="tag topic">${chapter.main_topic_category}</span>
                            ${(chapter.key_topics || []).map(topic =>
                `<span class="tag">${topic}</span>`
            ).join('')}
                        </div>
                        ${chapter.related_events?.length ? `
                            <div class="chapter-events">
                                <strong>Related Events:</strong>
                                <div class="tags">
                                    ${chapter.related_events.map(event =>
                `<span class="tag event">${event}</span>`
            ).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            `;

            document.getElementById('interviewModal').style.display = 'block';

            // Add debug button if video is present
            if (interview.videoEmbedLink) {
                setTimeout(() => addVideoDebugButton(), 100);
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('interviewModal').style.display = 'none';
        }

        // Filter interviews
        function filterInterviews() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const topicFilter = document.getElementById('topicFilter').value;
            const eventFilter = document.getElementById('eventFilter').value;

            filteredInterviews = interviewsData.filter(interview => {
                // Search term filter
                const matchesSearch = !searchTerm ||
                    interview.interview_name.toLowerCase().includes(searchTerm) ||
                    interview.main_summary?.summary.toLowerCase().includes(searchTerm) ||
                    interview.main_summary?.key_themes?.some(theme => theme.toLowerCase().includes(searchTerm));

                // Topic filter
                const matchesTopic = !topicFilter ||
                    interview.chapters?.some(chapter => chapter.main_topic_category === topicFilter);

                // Event filter
                const matchesEvent = !eventFilter ||
                    interview.chapters?.some(chapter =>
                        chapter.related_events?.includes(eventFilter));

                return matchesSearch && matchesTopic && matchesEvent;
            });

            displayInterviews();
        }

        // Format duration
        function formatDuration(seconds) {
            if (!seconds) return 'Unknown';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }

        // Convert HH:MM:SS timestamp to MM:SS format
        function formatTimestamp(timeString) {
            if (!timeString) return '';

            // Handle various timestamp formats
            const parts = timeString.split(':');
            if (parts.length === 3) {
                // HH:MM:SS format
                const hours = parseInt(parts[0]) || 0;
                const minutes = parseInt(parts[1]) || 0;
                const seconds = parseInt(parts[2]) || 0;

                // Convert to total minutes and seconds
                const totalMinutes = hours * 60 + minutes;
                return `${totalMinutes}:${seconds.toString().padStart(2, '0')}`;
            } else if (parts.length === 2) {
                // Already MM:SS format
                return timeString;
            }

            return timeString; // Return as-is if format is unclear
        }

        // Convert timestamp to seconds for video navigation
        function timestampToSeconds(timeString) {
            console.log(`Converting timestamp: "${timeString}"`);

            if (!timeString) {
                console.log('Empty timeString, returning 0');
                return 0;
            }

            const parts = timeString.split(':');
            console.log('Timestamp parts:', parts);

            if (parts.length === 3) {
                // HH:MM:SS format
                const hours = parseInt(parts[0]) || 0;
                const minutes = parseInt(parts[1]) || 0;
                const seconds = parseInt(parts[2]) || 0;

                const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                console.log(`HH:MM:SS format: ${hours}h ${minutes}m ${seconds}s = ${totalSeconds} total seconds`);
                return totalSeconds;
            } else if (parts.length === 2) {
                // MM:SS format
                const minutes = parseInt(parts[0]) || 0;
                const seconds = parseInt(parts[1]) || 0;

                const totalSeconds = minutes * 60 + seconds;
                console.log(`MM:SS format: ${minutes}m ${seconds}s = ${totalSeconds} total seconds`);
                return totalSeconds;
            }

            console.log('Unknown timestamp format, returning 0');
            return 0;
        }

        // Navigate video to specific timestamp
        function navigateToTimestamp(timestamp, interviewName) {
            console.log(`Navigating to ${timestamp} in ${interviewName}`);

            // Find the video iframe in the modal
            const iframe = document.querySelector('#interviewModal iframe');
            if (!iframe) {
                alert('Video player not found. Please open the interview details first.');
                return;
            }

            // Convert timestamp to seconds
            const seconds = timestampToSeconds(timestamp);
            console.log(`Converted ${timestamp} to ${seconds} seconds`);

            try {
                const currentSrc = iframe.src;
                console.log('Current iframe src:', currentSrc);

                let newSrc;

                // Handle different video platforms
                if (currentSrc.includes('youtube.com') || currentSrc.includes('youtu.be')) {
                    // YouTube handling
                    newSrc = handleYouTubeTimestamp(currentSrc, seconds);
                } else if (currentSrc.includes('vimeo.com')) {
                    // Vimeo handling
                    newSrc = handleVimeoTimestamp(currentSrc, seconds);
                } else {
                    // Generic handling - try common patterns
                    newSrc = handleGenericTimestamp(currentSrc, seconds);
                }

                if (newSrc && newSrc !== currentSrc) {
                    console.log('New iframe src:', newSrc);
                    iframe.src = newSrc;

                    // Add visual feedback
                    showTimestampFeedback(formatTimestamp(timestamp));
                } else {
                    console.warn('Could not generate new URL for timestamp navigation');
                    alert(`Timestamp navigation may not be supported for this video platform. Tried to navigate to ${formatTimestamp(timestamp)}.`);
                }

            } catch (error) {
                console.error('Error navigating video:', error);
                alert(`Could not navigate to timestamp ${formatTimestamp(timestamp)}. Error: ${error.message}`);
            }
        }

        // Handle YouTube timestamp navigation
        function handleYouTubeTimestamp(currentSrc, seconds) {
            console.log(`Handling YouTube timestamp: ${seconds} seconds`);
            console.log('Original URL:', currentSrc);

            // Remove existing time parameters
            let newSrc = currentSrc.split('&t=')[0].split('?t=')[0].split('#t=')[0].split('&start=')[0].split('?start=')[0];
            console.log('Cleaned URL:', newSrc);

            // For YouTube, we need to handle both embed and watch URLs
            if (newSrc.includes('/embed/')) {
                // YouTube embed URL
                const separator = newSrc.includes('?') ? '&' : '?';
                const finalUrl = `${newSrc}${separator}start=${seconds}&autoplay=1`;
                console.log('YouTube embed URL generated:', finalUrl);
                return finalUrl;
            } else if (newSrc.includes('youtube.com/watch')) {
                // YouTube watch URL (convert to embed for better control)
                try {
                    const videoId = new URL(newSrc).searchParams.get('v');
                    if (videoId) {
                        const finalUrl = `https://www.youtube.com/embed/${videoId}?start=${seconds}&autoplay=1`;
                        console.log('Converted watch URL to embed:', finalUrl);
                        return finalUrl;
                    }
                } catch (e) {
                    console.error('Error parsing YouTube watch URL:', e);
                }
            } else if (newSrc.includes('youtu.be/')) {
                // YouTube short URL
                const videoId = newSrc.split('youtu.be/')[1].split('?')[0];
                const finalUrl = `https://www.youtube.com/embed/${videoId}?start=${seconds}&autoplay=1`;
                console.log('Converted short URL to embed:', finalUrl);
                return finalUrl;
            }

            // Fallback - try adding t parameter
            const separator = newSrc.includes('?') ? '&' : '?';
            const finalUrl = `${newSrc}${separator}t=${seconds}s`;
            console.log('Fallback URL generated:', finalUrl);
            return finalUrl;
        }

        // Handle Vimeo timestamp navigation
        function handleVimeoTimestamp(currentSrc, seconds) {
            // Remove existing time parameters
            let newSrc = currentSrc.split('#t=')[0].split('?t=')[0];

            // For Vimeo, use the #t= parameter
            return `${newSrc}#t=${seconds}s`;
        }

        // Handle generic video platforms
        function handleGenericTimestamp(currentSrc, seconds) {
            // Try common timestamp parameters
            let newSrc = currentSrc.split('&t=')[0].split('?t=')[0].split('#t=')[0];

            // Try different parameter formats
            const separator = newSrc.includes('?') ? '&' : '?';

            // Most common patterns
            const patterns = [
                `${separator}t=${seconds}`,
                `${separator}time=${seconds}`,
                `${separator}start=${seconds}`,
                `#t=${seconds}s`
            ];

            // Return the first pattern (most likely to work)
            return newSrc + patterns[0];
        }

        // Show visual feedback when navigating to timestamp
        function showTimestampFeedback(formattedTime) {
            // Create a temporary notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #2ecc71;
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                transition: opacity 0.3s;
            `;
            notification.textContent = `‚è∞ Navigated to ${formattedTime}`;

            document.body.appendChild(notification);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', filterInterviews);
        document.getElementById('topicFilter').addEventListener('change', filterInterviews);
        document.getElementById('eventFilter').addEventListener('change', filterInterviews);

        // Close modal when clicking outside
        window.addEventListener('click', function (event) {
            const modal = document.getElementById('interviewModal');
            if (event.target === modal) {
                closeModal();
            }
        });

        // Drag and drop functionality for JSON files
        document.addEventListener('DOMContentLoaded', function () {
            const container = document.getElementById('interviewsContainer');

            container.addEventListener('dragover', function (e) {
                e.preventDefault();
                container.style.background = '#f0f8ff';
            });

            container.addEventListener('dragleave', function (e) {
                e.preventDefault();
                container.style.background = '';
            });

            container.addEventListener('drop', function (e) {
                e.preventDefault();
                container.style.background = '';

                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'application/json') {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            interviewsData = data.interviews || data || [];
                            updateStats();
                            populateFilters();
                            displayInterviews();
                        } catch (error) {
                            document.getElementById('errorContainer').innerHTML =
                                `<div class="error">Error reading JSON file: ${error.message}</div>`;
                        }
                    };
                    reader.readAsText(files[0]);
                }
            });
        });

        // Auto-load data when page loads
        // Add debugging button to test video navigation
        function addVideoDebugButton() {
            const iframe = document.querySelector('#interviewModal iframe');
            if (!iframe) return;

            // Create debug button
            const debugButton = document.createElement('button');
            debugButton.textContent = 'üîß Debug Video URL';
            debugButton.style.cssText = `
                position: absolute;
                top: 10px;
                left: 10px;
                background: #34495e;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 3px;
                font-size: 12px;
                cursor: pointer;
                z-index: 1000;
            `;

            debugButton.onclick = function () {
                const src = iframe.src;
                console.log('=== VIDEO DEBUG INFO ===');
                console.log('Current src:', src);
                console.log('Is YouTube:', src.includes('youtube.com') || src.includes('youtu.be'));
                console.log('Is Vimeo:', src.includes('vimeo.com'));

                try {
                    console.log('URL parts:', new URL(src));
                } catch (e) {
                    console.log('Could not parse URL:', e);
                }

                // Test timestamp conversion
                const testTimestamp = '15:30';
                const seconds = timestampToSeconds(testTimestamp);
                console.log(`Test: ${testTimestamp} = ${seconds} seconds`);

                // Show what the new URL would be
                let newSrc;
                if (src.includes('youtube.com') || src.includes('youtu.be')) {
                    newSrc = handleYouTubeTimestamp(src, seconds);
                } else if (src.includes('vimeo.com')) {
                    newSrc = handleVimeoTimestamp(src, seconds);
                } else {
                    newSrc = handleGenericTimestamp(src, seconds);
                }

                console.log('New URL would be:', newSrc);
                console.log('=== END DEBUG INFO ===');

                alert(`Debug info logged to console. Check console for details.`);
            };

            // Add to modal
            const modalContent = document.querySelector('.modal-content');
            if (modalContent) {
                modalContent.style.position = 'relative';
                modalContent.appendChild(debugButton);
            }
        }

        // Test timestamp conversion with various formats
        function testTimestampConversion() {
            console.log('=== TESTING TIMESTAMP CONVERSION ===');

            const testCases = [
                '00:15:30',  // 15 minutes 30 seconds
                '01:05:15',  // 1 hour 5 minutes 15 seconds  
                '15:30',     // 15 minutes 30 seconds
                '5:45',      // 5 minutes 45 seconds
                '0:30',      // 30 seconds
                '120:00'     // 2 hours
            ];

            testCases.forEach(testCase => {
                const seconds = timestampToSeconds(testCase);
                const formatted = formatTimestamp(testCase);
                console.log(`"${testCase}" -> ${seconds} seconds -> formatted as "${formatted}"`);
            });

            console.log('=== END TIMESTAMP TESTS ===');
        }

        window.addEventListener('load', function () {
            // Check if Firebase is properly configured
            if (typeof firebaseConfig !== 'undefined' &&
                firebaseConfig.projectId &&
                firebaseConfig.projectId !== "your-project-id-here") {
                loadFromFirestore();
            } else {
                showConfigurationHelp();
                loadExampleData();
            }
        });

        // Show configuration help
        function showConfigurationHelp() {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `
                <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h4>üîß Firebase Configuration Required</h4>
                    <p>To connect to your Firestore database, please update the Firebase configuration:</p>
                    <ol>
                        <li>Go to your Firebase Console (https://console.firebase.google.com/)</li>
                        <li>Select your project</li>
                        <li>Go to Project Settings ‚Üí General ‚Üí Your apps</li>
                        <li>Copy your Firebase config object</li>
                        <li>Edit this HTML file and replace the <code>firebaseConfig</code> object near the top</li>
                        <li>Look for the comment "Firebase configuration - replace these values"</li>
                        <li>Save the file and refresh this page</li>
                    </ol>
                    <p>For now, showing example data to demonstrate the interface.</p>
                </div>
            `;
        }
    </script>
</body>

</html>